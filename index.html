<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>üì∏ Face Dataset Collector</title>
<style>
  body { font-family: sans-serif; text-align: center; margin-top: 30px; }
  video { width: 360px; border: 3px solid #333; border-radius: 10px; }
  input, button { font-size: 18px; padding: 10px 18px; margin-top: 15px; }
  #status { margin-top: 15px; font-size: 18px; }
</style>
</head>
<body>

<h2>üì∏ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏†‡∏≤‡∏û‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (Dataset Collector)</h2>

<input id="username" type="text" placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏ñ‡πà‡∏≤‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô Ja">
<br>
<button id="startBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>

<br><br>
<video id="video" autoplay playsinline></video>
<div id="status">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‚úÖ</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

// ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á client
const supabase = createClient(
  "https://avhgcaymtekqopsrkntx.supabase.co", 
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF2aGdjYXltdGVrcW9wc3JrbnR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyODk1NzgsImV4cCI6MjA3Nzg2NTU3OH0.oH1dILXQ_P4rvpA6x74wtv3TsO9yLxZLcBigOAzRD3s"
);

// ‚úÖ ensure anonymous session
let { data: session } = await supabase.auth.getSession();
if (!session.session) {
  await supabase.auth.signInAnonymously();
}

// ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
const video = document.getElementById("video");
navigator.mediaDevices.getUserMedia({ video: true })
  .then(stream => video.srcObject = stream);

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô capture & upload
async function captureAndUpload(name, index){
  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext("2d").drawImage(video, 0, 0);

  const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/jpeg", 0.9));

  const path = `${name}/${index}.jpg`;

  const { error } = await supabase.storage.from("face-capture")
    .upload(path, blob, { upsert: true });

  if (error) {
    document.getElementById("status").innerHTML = `‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`;
  } else {
    const publicUrl = `https://avhgcaymtekqopsrkntx.supabase.co/storage/v1/object/public/face_dataset/${path}`;
    document.getElementById("status").innerHTML = `‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà ${index} <br> ${publicUrl}`;
  }
}

// ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢
document.getElementById("startBtn").addEventListener("click", () => {
  const name = document.getElementById("username").value.trim();
  if(!name) return alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô");

  alert("‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢ 30 ‡∏£‡∏π‡∏õ ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 15 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ");

  let index = 1;
  const total = 30;

  const timer = setInterval(() => {
    captureAndUpload(name, String(index).padStart(3, "0"));
    index++;
    if(index > total){
      clearInterval(timer);
      alert("‚úÖ ‡∏ñ‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß!");
      document.getElementById("status").innerHTML = "‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô";
    }
  }, 500);
});
</script>

</body>
</html>
