<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡πà‡∏≤‡∏¢‡∏ä‡∏∏‡∏î‡∏†‡∏≤‡∏û‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (Dataset Collector)</title>
<style>
  body { font-family: sans-serif; text-align: center; margin-top: 20px; transition: background 0.3s; }
  video { width: 320px; border: 3px solid #333; margin-top: 10px; }
  #step { font-size: 22px; margin-top: 20px; font-weight: bold; }
  #progress { margin-top: 10px; font-size: 18px; }
  input, button { padding: 8px 12px; font-size: 18px; margin-top: 10px; }
</style>
</head>
<body>

<h2>üì∏ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏°‡πÄ‡∏î‡∏•</h2>

<input id="username" type="text" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°" />
<button id="startBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢</button>

<div id="step"></div>
<video id="video" autoplay playsinline></video>
<div id="progress"></div>

<!-- ‚úÖ ‡πÇ‡∏´‡∏•‡∏î Mediapipe ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/face_detection.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://avhgcaymtekqopsrkntx.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF2aGdjYXltdGVrcW9wc3JrbnR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyODk1NzgsImV4cCI6MjA3Nzg2NTU3OH0.oH1dILXQ_P4rvpA6x74wtv3TsO9yLxZLcBigOAzRD3s"
);

await supabase.auth.signInAnonymously();

const video = document.getElementById("video");

// ‚úÖ ‡πÉ‡∏ä‡πâ camera_utils ‡πÉ‡∏´‡πâ Mediapipe ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á
const camera = new Camera(video, {
  onFrame: async () => {
    await detector.send({image: video});
  },
  width: 320,
  height: 240
});
camera.start();

// ‚úÖ ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ constructor ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!!
const detector = new faceDetection.FaceDetection({
  model: "short",
  minDetectionConfidence: 0.7
});

const steps = [
  "‡∏´‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡∏ä‡πâ‡∏≤‡πÜ",
  "‡∏´‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤‡∏ä‡πâ‡∏≤‡πÜ",
  "‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ‡πÄ‡∏á‡∏¢‡∏´‡∏ô‡πâ‡∏≤",
  "‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏á‡∏õ‡∏Å‡∏ï‡∏¥"
];
const colors = ["#FFD1D1","#D1E8FF","#E2FFD1","#FFF3B0"];

let currentStep = 0, count = 0;
const totalPerStep = 25;
const total = totalPerStep * steps.length;

async function uploadToSupabase(folder, filename, blob) {
  await supabase.storage.from("face_dataset")
    .upload(`${folder}/${filename}.jpg`, blob, { upsert: true });
}

async function startCapture(){
  const name = document.getElementById("username").value.trim();
  if (!name) return alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠");

  alert("‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß");

  let timer = setInterval(async () => {
    document.body.style.backgroundColor = colors[currentStep];
    document.getElementById("step").innerHTML = steps[currentStep];
    document.getElementById("progress").innerHTML = `${count+1}/${total}`;

    const results = detector.getDetections();
    if(results?.detections){
      const box = results.detections[0].locationData.relativeBoundingBox;
      const w = video.videoWidth, h = video.videoHeight;

      const x = box.xmin * w;
      const y = box.ymin * h;
      const width = box.width * w;
      const height = box.height * h;

      let canvas = document.createElement("canvas");
      canvas.width = 160; canvas.height = 160;
      canvas.getContext("2d").drawImage(video, x, y, width, height, 0, 0, 160, 160);

      canvas.toBlob(blob =>
        uploadToSupabase(name, String(count+1).padStart(3,"0"), blob), "image/jpeg", 0.9);
    }

    count++;
    if(count % totalPerStep === 0 && currentStep < steps.length-1) currentStep++;
    if(count >= total){
      clearInterval(timer);
      document.body.style.backgroundColor = "white";
      alert(`‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô face_dataset/${name}`);
    }
  }, 500);
}

// ‚úÖ ‡∏ú‡∏π‡∏Å‡πÅ‡∏ö‡∏ö‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ onclick ‡πÅ‡∏•‡πâ‡∏ß
document.getElementById("startBtn").addEventListener("click", startCapture);
</script>

</body>
</html>
