<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>üì∏ Face Dataset Collector</title>
<style>
  body { font-family: sans-serif; text-align: center; padding-top: 20px; transition: background 0.3s; }
  video { width: 360px; border: 3px solid #333; border-radius: 10px; margin-top: 10px; }
  input, button { font-size: 18px; padding: 10px 14px; margin-top: 12px; }
  #step { margin-top: 18px; font-size: 22px; font-weight: bold; }
  #progress { margin-top: 8px; font-size: 18px; }
</style>
</head>
<body>

<h2>üì∏ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∏‡∏î‡∏†‡∏≤‡∏û‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (Dataset Collector)</h2>

<input id="username" type="text" placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠ ‡πÄ‡∏ä‡πà‡∏ô Ja">
<br>
<button id="startBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>

<div id="step">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°...</div>
<video id="video" autoplay playsinline></video>
<div id="progress"></div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

// ‚úÖ Supabase client
const supabase = createClient(
  "https://avhgcaymtekqopsrkntx.supabase.co", 
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF2aGdjYXltdGVrcW9wc3JrbnR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyODk1NzgsImV4cCI6MjA3Nzg2NTU3OH0.oH1dILXQ_P4rvpA6x74wtv3TsO9yLxZLcBigOAzRD3s"
);
await supabase.auth.signInAnonymously();

const video = document.getElementById("video");
navigator.mediaDevices.getUserMedia({ video: true })
  .then(stream => video.srcObject = stream);

// ‚úÖ Step text
const steps = [
  "‡∏´‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏õ‡∏ó‡∏≤‡∏á **‡∏ã‡πâ‡∏≤‡∏¢** ‡∏ä‡πâ‡∏≤‡πÜ",
  "‡∏´‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏õ‡∏ó‡∏≤‡∏á **‡∏Ç‡∏ß‡∏≤** ‡∏ä‡πâ‡∏≤‡πÜ",
  "‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ **‡πÄ‡∏á‡∏¢‡∏´‡∏ô‡πâ‡∏≤**",
  "‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ **‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏á**"
];

// ‚úÖ ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏£‡πá‡∏ß
const bgColors = [
  "#FFFFFF"
  // "#330000",
  // "#001A33",
  // "#003300",
  // "#220044",
  // "#660000"
];

let colorIndex = 0;
setInterval(() => {
  document.body.style.backgroundColor = bgColors[colorIndex];
  colorIndex = (colorIndex + 1) % bgColors.length;
}, 1500);

// ‚úÖ 300 ‡∏£‡∏π‡∏õ = 75 ‡∏£‡∏π‡∏õ‡∏ï‡πà‡∏≠‡∏ó‡πà‡∏≤
let count = 0;
let stepIndex = 0;
const perStep = 75;

document.getElementById("startBtn").addEventListener("click", () => {
  const name = document.getElementById("username").value.trim();
  if (!name) return alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô");

  // alert("‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 300 ‡∏£‡∏π‡∏õ ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 1 ‡∏ô‡∏≤‡∏ó‡∏µ");

  const timer = setInterval(() => {

    document.getElementById("step").innerHTML = steps[stepIndex];
    document.getElementById("progress").innerHTML = `${count+1}/300`;

    const canvas = document.createElement("canvas");
    canvas.width = 240;
    canvas.height = 240;
    canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height);

    canvas.toBlob((blob) => {
      const fileName = String(count+1).padStart(3, "0");
      supabase.storage.from("dataset")
        .upload(`${name}/${fileName}.jpg`, blob, { upsert: true });
    }, "image/jpeg", 0.85);

    count++;

    if(count % perStep === 0 && stepIndex < 3) stepIndex++;

    if(count >= 300){
      clearInterval(timer);
      document.body.style.backgroundColor = "white";
      document.getElementById("step").innerHTML = "‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô";
      alert(`‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
    }

  }, 200); // ‡∏ñ‡πà‡∏≤‡∏¢‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô!
});
</script>

</body>
</html>
