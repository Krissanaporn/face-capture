<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡πà‡∏≤‡∏¢‡∏ä‡∏∏‡∏î‡∏†‡∏≤‡∏û‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (Dataset Collector)</title>
<style>
  body { font-family: sans-serif; text-align: center; margin-top: 20px; }
  video { width: 320px; border: 3px solid #333; margin-top: 10px; }
  #step { font-size: 22px; margin-top: 20px; font-weight: bold; }
  #progress { margin-top: 10px; font-size: 18px; }
  input, button { padding: 8px 12px; font-size: 18px; margin-top: 10px; }
</style>
</head>
<body>

<h2>üì∏ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏°‡πÄ‡∏î‡∏•</h2>

<input id="username" type="text" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°" />
<button onclick="startCapture()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢</button>

<div id="step"></div>
<video id="video" autoplay playsinline></video>
<div id="progress"></div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/face_detection.js"></script>

<!-- Supabase -->
<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient("YOUR_SUPABASE_URL", "YOUR_SUPABASE_ANON_KEY");

// Login ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏±‡∏Ñ‡∏£ ‚Üí ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå upload
await supabase.auth.signInAnonymously();

const video = document.getElementById("video");
navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
  video.srcObject = stream;
});

const steps = [
  "‡∏´‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏õ‡∏ó‡∏≤‡∏á **‡∏ã‡πâ‡∏≤‡∏¢** ‡∏ä‡πâ‡∏≤‡πÜ",
  "‡∏´‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏õ‡∏ó‡∏≤‡∏á **‡∏Ç‡∏ß‡∏≤** ‡∏ä‡πâ‡∏≤‡πÜ",
  "‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ **‡πÄ‡∏á‡∏¢‡∏´‡∏ô‡πâ‡∏≤**",
  "‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ **‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏á‡∏õ‡∏Å‡∏ï‡∏¥**"
];

const colors = ["#FFD1D1","#D1E8FF","#E2FFD1","#FFF3B0"];
let currentStep = 0;
let count = 0;
const totalPerStep = 25;
const total = totalPerStep * steps.length;

const detector = new FaceDetection.FaceDetection({model: "short", minDetectionConfidence: 0.7});

async function uploadToSupabase(folder, filename, blob) {
  const { error } = await supabase
    .storage
    .from("face_dataset")
    .upload(`${folder}/${filename}.jpg`, blob, { upsert: true });

  if (error) console.log("‚ùå Upload failed:", error.message);
}

async function startCapture(){
  const name = document.getElementById("username").value.trim();
  if (!name){
    alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô");
    return;
  }

  alert("‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏ô‡∏à‡∏≠‡∏ó‡∏µ‡∏•‡∏∞‡∏ó‡πà‡∏≤ üòä");

  let timer = setInterval(async ()=>{

    document.body.style.backgroundColor = colors[currentStep];
    document.getElementById("step").innerHTML = `‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô: ${steps[currentStep]}`;
    document.getElementById("progress").innerHTML = `üì∏ ${count+1}/${total}`;

    let canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext("2d").drawImage(video, 0, 0);

    const {detections} = await detector.send({image: canvas});
    if(detections && detections.length > 0){

      let b = detections[0].boundingBox;
      let x = b.xCenter - b.width/2;
      let y = b.yCenter - b.height/2;

      let face = document.createElement("canvas");
      face.width = 160;
      face.height = 160;
      face.getContext("2d").drawImage(canvas, x, y, b.width, b.height, 0, 0, 160, 160);

      face.toBlob(blob => {
        uploadToSupabase(name, String(count+1).padStart(3,"0"), blob);
      }, "image/jpeg", 0.9);
    }

    count++;

    if (count % totalPerStep === 0 && currentStep < steps.length - 1){
      currentStep++;
    }

    if(count >= total){
      clearInterval(timer);
      document.getElementById("step").innerHTML = "‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß";
      document.body.style.backgroundColor = "white";
      alert("‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß!\n‡πÑ‡∏ü‡∏•‡πå‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô Supabase Bucket: face_dataset/" + name);
    }

  }, 500);
}
</script>

</body>
</html>
