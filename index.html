<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡πÄ‡∏Å‡πá‡∏ö‡∏†‡∏≤‡∏û‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏ß‡πá‡∏ö</title>
<style>
  body { font-family: sans-serif; text-align: center; margin-top: 30px; }
  video { width: 350px; border: 3px solid #333; border-radius: 10px; }
  input, button { font-size: 20px; padding: 10px 18px; margin-top: 15px; }
</style>
</head>
<body>

<h2>üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (Dataset Collector)</h2>

<input id="username" type="text" placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏ñ‡πà‡∏≤‡∏¢">
<br>
<button id="startBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û</button>

<br><br>
<video id="video" autoplay playsinline></video>
<div id="status"></div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://avhgcaymtekqopsrkntx.supabase.co", 
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF2aGdjYXltdGVrcW9wc3JrbnR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyODk1NzgsImV4cCI6MjA3Nzg2NTU3OH0.oH1dILXQ_P4rvpA6x74wtv3TsO9yLxZLcBigOAzRD3s"
);

// ‚úÖ Login anonymous ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
await supabase.auth.signInAnonymously();

// ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
const video = document.getElementById("video");
navigator.mediaDevices.getUserMedia({ video: true }).then(stream => video.srcObject = stream);

async function captureAndUpload(name, index){
  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext("2d").drawImage(video, 0, 0);

  canvas.toBlob(async blob => {

    const { data, error } = await supabase.storage
      .from("face_dataset")
      .upload(`${name}/${index}.jpg`, blob, { upsert: true });
    
    if (error) {
      console.error("UPLOAD ERROR:", error);
      alert("UPLOAD ERROR: " + error.message);
    } else {
      console.log("‚úÖ UPLOADED:", data);
    }
  }, "image/jpeg", 0.9);
}
document.getElementById("startBtn").addEventListener("click", async () => {
  const name = document.getElementById("username").value.trim();
  if(!name) return alert("‚ö†Ô∏è ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô");

  alert("‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û 30 ‡∏£‡∏π‡∏õ (‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 15 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)");

  let index = 1;
  const total = 30;

  const timer = setInterval(() => {
    captureAndUpload(name, String(index).padStart(3, "0"));
    index++;
    if(index > total){
      clearInterval(timer);
      alert("‚úÖ ‡∏ñ‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß!");
    }
  }, 500);
});
</script>

</body>
</html>
